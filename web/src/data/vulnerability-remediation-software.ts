/**
 * Demo data: Vulnerability Remediation â€” Outdated Software
 */
import { PlaybookGraph, PlaybookLibraryItem } from '../types';

export const markdown = `# Vulnerability Remediation Playbook: Outdated Software
**Type:** Vulnerability Management / Software Deployment Validation
**Tooling:** Wazuh (detection) + Active Directory GPO (remediation)
**Last Updated:** 2026-02-02

---

## Overview
Standardized response for CVE alerts triggered by outdated software deployments across the fleet.

## Detection (Wazuh)

### Initial Query
\`\`\`sql
SELECT agent_name, data->>'vulnerability.package.name' as software,
       data->>'vulnerability.package.version' as version,
       data->>'vulnerability.cve' as cve
FROM alerts
WHERE rule_group LIKE '%vulnerability%'
  AND data->>'vulnerability.package.name' = 'Adobe Acrobat'
GROUP BY agent_name;
\`\`\`

### Triage Questions
1. What software/version is triggering?
2. How many assets affected?
3. Is this software business-critical?
4. Is latest version actually available?

## Investigation

### Step 1: Verify Current Version
\`\`\`powershell
Get-ItemProperty HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\* |
    Where-Object {\$_.DisplayName -like "*Adobe*"} |
    Select DisplayName, DisplayVersion
\`\`\`

### Step 2: Check Windows Store for Current Version
- Open Microsoft Store
- Search for software
- Compare version numbers

### Step 3: Identify Deployment Source
- Check SCCM/WSUS for deployment history
- If originally deployed via SCCM, coordinate with IT
- Otherwise escalate to asset owner

## Remediation

### Option A: GPO-Based Removal + Reinstall (Preferred)
1. Open Group Policy Management
2. Create new GPO: "Remove [Software] - Vuln Remediation"
3. Link to affected OU
4. Set deployment to Uninstall mode
5. Force removal of existing installations

### Option B: Manual Remediation (Single/Testing)
1. Uninstall via Control Panel/Settings
2. Run vendor cleanup tool if available
3. Reboot
4. Install latest from Windows Store

### Verification Script
\`\`\`powershell
\$installed = Get-ItemProperty HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\* |
    Where-Object {\$_.DisplayName -like "*Adobe Acrobat*"}

if (\$installed.DisplayVersion -ge "23.0") {
    Write-Host "[PASS] Current version installed"
} else {
    Write-Host "[FAIL] Outdated or missing"
}
\`\`\`

## Verification

### Wazuh Confirmation
\`\`\`sql
SELECT agent_name, data->>'vulnerability.cve' as cve,
       data->>'vulnerability.status' as status
FROM alerts
WHERE data->>'vulnerability.cve' IN ('CVE-XXXX-XXXXX')
  AND timestamp > NOW() - INTERVAL '1 day';
\`\`\`

## Post-Incident
1. Record GPO settings used
2. Save PowerShell scripts to shared location
3. Update software inventory database
4. Add software deployment validation step
5. Notify affected users of software change
`;

export const graph: PlaybookGraph = {
  nodes: [
    { id: 'node_0', label: 'Vulnerability Remediation Playbook: Outdated Software', type: 'phase', metadata: { level: 1, header_type: 'h1' } },
    { id: 'node_1', label: 'Overview', type: 'phase', metadata: { level: 2, header_type: 'h2' } },
    { id: 'node_2', label: 'Detection (Wazuh)', type: 'phase', metadata: { level: 2, header_type: 'h2' } },
    { id: 'node_3', label: 'Initial Query', type: 'phase', metadata: { level: 3, header_type: 'h3' } },
    { id: 'node_4', label: 'Execute sql', type: 'execute', metadata: { language: 'sql' } },
    { id: 'node_5', label: 'Triage Questions', type: 'phase', metadata: { level: 3, header_type: 'h3' } },
    { id: 'node_6', label: 'What software/version is triggering?', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_7', label: 'How many assets affected?', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_8', label: 'Is this software business-critical?', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_9', label: 'Is latest version actually available?', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_10', label: 'Investigation', type: 'phase', metadata: { level: 2, header_type: 'h2' } },
    { id: 'node_11', label: 'Step 1: Verify Current Version', type: 'phase', metadata: { level: 3, header_type: 'h3' } },
    { id: 'node_12', label: 'Execute powershell', type: 'execute', metadata: { language: 'powershell' } },
    { id: 'node_13', label: 'Step 2: Check Windows Store for Current Version', type: 'phase', metadata: { level: 3, header_type: 'h3' } },
    { id: 'node_14', label: 'Step 3: Identify Deployment Source', type: 'phase', metadata: { level: 3, header_type: 'h3' } },
    { id: 'node_15', label: 'Originally deployed via SCCM, coordinate with IT?', type: 'decision', metadata: { condition: 'If originally deployed via SCCM, coordinate with IT' } },
    { id: 'node_16', label: 'Remediation', type: 'phase', metadata: { level: 2, header_type: 'h2' } },
    { id: 'node_17', label: 'Option A: GPO-Based Removal + Reinstall (Preferred)', type: 'phase', metadata: { level: 3, header_type: 'h3' } },
    { id: 'node_18', label: 'Open Group Policy Management', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_19', label: 'Create new GPO: "Remove [Software] - Vuln Remediation"', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_20', label: 'Link to affected OU', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_21', label: 'Set deployment to Uninstall mode', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_22', label: 'Force removal of existing installations', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_23', label: 'Option B: Manual Remediation (Single/Testing)', type: 'phase', metadata: { level: 3, header_type: 'h3' } },
    { id: 'node_24', label: 'Uninstall via Control Panel/Settings', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_25', label: 'Run vendor cleanup tool if available', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_26', label: 'Reboot', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_27', label: 'Install latest from Windows Store', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_28', label: 'Verification Script', type: 'phase', metadata: { level: 3, header_type: 'h3' } },
    { id: 'node_29', label: 'Execute powershell', type: 'execute', metadata: { language: 'powershell' } },
    { id: 'node_30', label: 'Verification', type: 'phase', metadata: { level: 2, header_type: 'h2' } },
    { id: 'node_31', label: 'Wazuh Confirmation', type: 'phase', metadata: { level: 3, header_type: 'h3' } },
    { id: 'node_32', label: 'Execute sql', type: 'execute', metadata: { language: 'sql' } },
    { id: 'node_33', label: 'Post-Incident', type: 'phase', metadata: { level: 2, header_type: 'h2' } },
    { id: 'node_34', label: 'Record GPO settings used', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_35', label: 'Save PowerShell scripts to shared location', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_36', label: 'Update software inventory database', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_37', label: 'Add software deployment validation step', type: 'step', metadata: { step_type: 'sequential' } },
    { id: 'node_38', label: 'Notify affected users of software change', type: 'step', metadata: { step_type: 'sequential' } },
  ],
  edges: [
    { id: 'edge_0', source: 'node_0', target: 'node_1' },
    { id: 'edge_1', source: 'node_1', target: 'node_2' },
    { id: 'edge_2', source: 'node_2', target: 'node_3' },
    { id: 'edge_3', source: 'node_3', target: 'node_4' },
    { id: 'edge_4', source: 'node_4', target: 'node_5' },
    { id: 'edge_5', source: 'node_5', target: 'node_6' },
    { id: 'edge_6', source: 'node_6', target: 'node_7' },
    { id: 'edge_7', source: 'node_7', target: 'node_8' },
    { id: 'edge_8', source: 'node_8', target: 'node_9' },
    { id: 'edge_9', source: 'node_9', target: 'node_10' },
    { id: 'edge_10', source: 'node_10', target: 'node_11' },
    { id: 'edge_11', source: 'node_11', target: 'node_12' },
    { id: 'edge_12', source: 'node_12', target: 'node_13' },
    { id: 'edge_13', source: 'node_13', target: 'node_14' },
    { id: 'edge_14', source: 'node_14', target: 'node_15' },
    { id: 'edge_15', source: 'node_15', target: 'node_16' },
    { id: 'edge_16', source: 'node_16', target: 'node_17' },
    { id: 'edge_17', source: 'node_17', target: 'node_18' },
    { id: 'edge_18', source: 'node_18', target: 'node_19' },
    { id: 'edge_19', source: 'node_19', target: 'node_20' },
    { id: 'edge_20', source: 'node_20', target: 'node_21' },
    { id: 'edge_21', source: 'node_21', target: 'node_22' },
    { id: 'edge_22', source: 'node_22', target: 'node_23' },
    { id: 'edge_23', source: 'node_23', target: 'node_24' },
    { id: 'edge_24', source: 'node_24', target: 'node_25' },
    { id: 'edge_25', source: 'node_25', target: 'node_26' },
    { id: 'edge_26', source: 'node_26', target: 'node_27' },
    { id: 'edge_27', source: 'node_27', target: 'node_28' },
    { id: 'edge_28', source: 'node_28', target: 'node_29' },
    { id: 'edge_29', source: 'node_29', target: 'node_30' },
    { id: 'edge_30', source: 'node_30', target: 'node_31' },
    { id: 'edge_31', source: 'node_31', target: 'node_32' },
    { id: 'edge_32', source: 'node_32', target: 'node_33' },
    { id: 'edge_33', source: 'node_33', target: 'node_34' },
    { id: 'edge_34', source: 'node_34', target: 'node_35' },
    { id: 'edge_35', source: 'node_35', target: 'node_36' },
    { id: 'edge_36', source: 'node_36', target: 'node_37' },
    { id: 'edge_37', source: 'node_37', target: 'node_38' },
  ],
};

export const libraryItem: PlaybookLibraryItem = {
  slug: 'vulnerability-remediation-software',
  metadata: {
    title: 'Vulnerability Remediation Playbook: Outdated Software',
    type: 'Vulnerability Management / Software Deployment Validation',
    tooling: 'Wazuh (detection) + Active Directory GPO (remediation)',
    lastUpdated: '2026-02-02',
  },
  category: 'vulnerability-remediation',
  markdown,
  graph,
  description:
    'Standardized response for CVE alerts triggered by outdated software deployments across the fleet.',
  tags: ['software', 'cve', 'wazuh', 'gpo', 'active-directory', 'deployment'],
};
