# PRD: Phase 3 - Export + Sharing

**Project:** Playbook Forge
**Phase:** 3 of 6
**Priority:** P1 (Quick win, low effort, high utility)
**Estimated Effort:** Low (1-2 build sessions)
**Depends on:** Phase 2 (CRUD + Persistence)

---

## Problem Statement

Playbooks created in Playbook Forge are trapped inside the tool. Users can't export them for use in other systems, share them with colleagues, back them up, or print them for incident response binders. A playbook tool that can't output playbooks is a flowchart toy.

## Goal

Export playbooks in multiple formats (Markdown, Mermaid, JSON, PDF) and enable sharing via read-only links and print-friendly views.

## Requirements

### 3.1 Backend: Export Endpoints

**Sub-agent assignment:** Codex (GPT 5.3) - structured API work

| Task | Description |
|------|-------------|
| 3.1.1 | `GET /api/playbooks/{id}/export?format=markdown` - Reconstruct clean Markdown from graph_json. Phases become `## Phase:`, steps become `- Step:`, decisions become `- Decision:` with YES/NO branches. Must round-trip: export -> re-import should produce equivalent graph. |
| 3.1.2 | `GET /api/playbooks/{id}/export?format=mermaid` - Generate Mermaid `flowchart TD` syntax from graph_json. Map node types to Mermaid shapes (Phase=`[]`, Decision=`{}`, Execute=`(())`, Step=`[]`). |
| 3.1.3 | `GET /api/playbooks/{id}/export?format=json` - Full JSON dump: playbook metadata + graph_json + tags + version history. For backup/restore. |
| 3.1.4 | `POST /api/playbooks/import` - Accept JSON export and create new playbook from it. Validates schema before importing. |
| 3.1.5 | `POST /api/playbooks/import/bulk` - Accept array of markdown files (multipart upload). Parse each and create playbook entries. Return success/failure per file. |

### 3.2 Backend: PDF Generation

**Sub-agent assignment:** Codex (GPT 5.3)

| Task | Description |
|------|-------------|
| 3.2.1 | `GET /api/playbooks/{id}/export?format=pdf` - Generate PDF with: title page (playbook name, category, date, tags), flowchart image (render Mermaid server-side via mermaid-cli or capture), step-by-step text breakdown, footer with "Generated by Playbook Forge". |
| 3.2.2 | Use WeasyPrint (already used in our resume pipeline) or reportlab. HTML template -> PDF. |
| 3.2.3 | Optional branding: accept `?logo_url` and `?org_name` query params for custom headers. |

### 3.3 Backend: Share Links

**Sub-agent assignment:** Codex (GPT 5.3)

| Task | Description |
|------|-------------|
| 3.3.1 | Add `share_token` column to Playbook table (nullable UUID). |
| 3.3.2 | `POST /api/playbooks/{id}/share` - Generate a share token, return share URL. |
| 3.3.3 | `DELETE /api/playbooks/{id}/share` - Revoke share link. |
| 3.3.4 | `GET /api/shared/{token}` - Public endpoint, returns playbook in read-only format (no edit, no delete, no version history). |

### 3.4 Frontend: Export UI

**Sub-agent assignment:** Codex (GPT 5.3)

| Task | Description |
|------|-------------|
| 3.4.1 | Export dropdown button on playbook view page: Markdown, Mermaid, JSON, PDF options. Each triggers download. |
| 3.4.2 | "Copy to Clipboard" for Markdown and Mermaid exports (no download needed for quick sharing). |
| 3.4.3 | Import page: drag-and-drop zone for JSON files and markdown files. Show preview before confirming import. |
| 3.4.4 | Bulk import: folder upload or multi-file select. Progress bar showing parse status per file. |

### 3.5 Frontend: Share + Print

**Sub-agent assignment:** Codex (GPT 5.3)

| Task | Description |
|------|-------------|
| 3.5.1 | Share button on playbook view: generates link, shows copy-to-clipboard UI. Toggle to revoke. |
| 3.5.2 | Shared view page (`#/shared/:token`): read-only flowchart + step list. Clean, no chrome. Shows "View in Playbook Forge" CTA. |
| 3.5.3 | Print-friendly CSS (`@media print`): hide nav, controls, sidebar. Full-width flowchart + step breakdown. Page breaks between phases. |
| 3.5.4 | Ctrl+P from any playbook view should produce a clean printed page. |

## Non-Goals (Phase 3)

- No real-time collaboration (just sharing read-only links)
- No commenting on shared playbooks
- No export to SOAR formats (Phase 4)
- No cloud storage integration (Google Drive, S3)

## Technical Decisions

- **WeasyPrint** for PDF: already in our stack from resume generation, handles HTML/CSS to PDF well
- **Mermaid CLI** (`@mermaid-js/mermaid-cli`) for server-side flowchart rendering in PDFs. Alternatively, capture the React Flow canvas as SVG/PNG on the client and send to backend.
- **UUID share tokens** over sequential IDs: unguessable, revocable
- **Export as graph reconstruction**, not raw content dump: ensures exports are clean and properly formatted even if the user's original markdown was messy

## Success Criteria

1. All four export formats (MD, Mermaid, JSON, PDF) produce valid, usable output
2. JSON export -> import round-trips perfectly (no data loss)
3. Markdown export -> re-import produces equivalent graph (within reason)
4. Share links work without authentication
5. Share links can be revoked
6. Printed output is clean and professional
7. Bulk import handles 10+ files without issues

## Deployment Notes

- WeasyPrint needs system deps (`libpango`, `libcairo`). Add to Dockerfile or document for local install.
- Mermaid CLI needs headless Chromium. Consider client-side canvas capture as lighter alternative.
- Share tokens should be indexed in SQLite for fast lookup.
